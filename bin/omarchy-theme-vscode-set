#!/usr/bin/env bash

set -e

THEME_NAME="$1"
EXTENSION_ID="$2"

if [[ -z "$THEME_NAME" ]]; then
  echo "Usage: $0 <Theme Name> [<Extension ID>]"
  exit 1
fi

SETTINGS_FILE="$HOME/.config/Code/User/settings.json"

# Ensure settings.json exists
mkdir -p "$(dirname "$SETTINGS_FILE")"
touch "$SETTINGS_FILE"
if ! grep -q '{' "$SETTINGS_FILE"; then
  echo "{}" > "$SETTINGS_FILE"
fi

# Install extension if ID is provided and not installed yet
if [[ -n "$EXTENSION_ID" ]]; then
  if ! code --list-extensions | grep -q "^$EXTENSION_ID$"; then
    code --install-extension "$EXTENSION_ID" --force
  fi
fi

# Update theme in settings.json
tmpfile=$(mktemp)
if [[ "$THEME_NAME" =~ ^(Dark[[:space:]]Modern|default)$ ]]; then
  jq 'del(.["workbench.colorTheme"])' "$SETTINGS_FILE" > "$tmpfile"
else
  jq --arg theme "$THEME_NAME" '. + {"workbench.colorTheme": $theme}' \
    "$SETTINGS_FILE" > "$tmpfile"
fi

mv "$tmpfile" "$SETTINGS_FILE"

# Reload VS Code window if running
# if pgrep -f 'code' >/dev/null; then
#   echo "Reloading VS Code window to apply theme..."
#   code --command workbench.action.reloadWindow
# else
#   echo "VS Code not running. Theme will apply on next start."
# fi
